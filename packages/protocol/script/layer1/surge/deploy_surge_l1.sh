#!/bin/sh

# This script deploys the Surge protocol on L1
set -e

# Deployer private key
export PRIVATE_KEY=${PRIVATE_KEY:-"0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"}

# Network configuration
export FORK_URL=${FORK_URL:-"http://localhost:8545"}

# Owner and executor configuration
export USE_TIMELOCKED_OWNER=${USE_TIMELOCKED_OWNER:-true}
# (Remaining are only required if USE_TIMELOCKED_OWNER is true)
export OWNER_MULTISIG=${OWNER_MULTISIG:-"0x60997970C51812dc3A010C7d01b50e0d17dc79C8"}
export OWNER_MULTISIG_SIGNERS=${OWNER_MULTISIG_SIGNERS:-"0x1237810000000000000000000000000000000002,0x1237810000000000000000000000000000000003,0x1237810000000000000000000000000000000004"}
export TIMELOCK_PERIOD=${TIMELOCK_PERIOD:-86400}

# DAO configuration
export DAO=${DAO:-"0x1237810000000000000000000000000000000001"}

# L2 configuration
export L2_CHAINID=${L2_CHAINID:-167004}
export L2_GENESIS_HASH=${L2_GENESIS_HASH:-"0xee1950562d42f0da28bd4550d88886bc90894c77c9c9eaefef775d4c8223f259"}

# Liveness configuration
export MAX_VERIFICATION_DELAY=${MAX_VERIFICATION_DELAY:-100}
export MIN_VERIFICATION_STREAK=${MIN_VERIFICATION_STREAK:-10}
export LIVENESS_BOND_BASE=${LIVENESS_BOND_BASE:-1000000000000000000}
export LIVENESS_BOND_PER_BLOCK=${LIVENESS_BOND_PER_BLOCK:-100000000000000000}

# Preconf configuration
export USE_PRECONF=${USE_PRECONF:-false}
# (Remaining are only required if USE_PRECONF is true)
export INCLUSION_WINDOW=${INCLUSION_WINDOW:-24}
export INCLUSION_FEE_IN_GWEI=${INCLUSION_FEE_IN_GWEI:-100}
export FALLBACK_PRECONF=${FALLBACK_PRECONF:-"0x0000000000000000000000000000000000000000"}

# Verifier configuration
export SHOULD_SETUP_VERIFIERS=${SHOULD_SETUP_VERIFIERS:-false}

# RISC0 verifier configuration
export RISC0_BLOCK_PROVING_IMAGE_ID=${RISC0_BLOCK_PROVING_IMAGE_ID:-"0x0000000000000000000000000000000000000000000000000000000000000000"}
export RISC0_AGGREGATION_IMAGE_ID=${RISC0_AGGREGATION_IMAGE_ID:-"0x0000000000000000000000000000000000000000000000000000000000000000"}

# SP1 verifier configuration
export SP1_BLOCK_PROVING_PROGRAM_VKEY=${SP1_BLOCK_PROVING_PROGRAM_VKEY:-"0x0000000000000000000000000000000000000000000000000000000000000000"}
export SP1_AGGREGATION_PROGRAM_VKEY=${SP1_AGGREGATION_PROGRAM_VKEY:-"0x0000000000000000000000000000000000000000000000000000000000000000"}

# SGX verifier configuration
export MR_ENCLAVE=${MR_ENCLAVE:-"0x0000000000000000000000000000000000000000000000000000000000000000"}
export MR_SIGNER=${MR_SIGNER:-"0x0000000000000000000000000000000000000000000000000000000000000000"}
export QEID_PATH=${QEID_PATH:-"/test/layer1/automata-attestation/assets/0923/identity.json"}
export TCB_INFO_PATH=${TCB_INFO_PATH:-"/test/layer1/automata-attestation/assets/0923/tcb_00606A000000.json"}
export V3_QUOTE_BYTES=${V3_QUOTE_BYTES:-"0x"}

# Deploy Surge protocol
export FOUNDRY_PROFILE=${FOUNDRY_PROFILE:-"layer1"}

# Broadcast transactions
export BROADCAST=${BROADCAST:-false}

# Parameterize broadcasting
export BROADCAST_ARG=""
if [ "$BROADCAST" = "true" ]; then
    BROADCAST_ARG="--broadcast"
fi

# Parameterize log level
export LOG_LEVEL=${LOG_LEVEL:-"-vvvv"}

# Parameterize block gas limit
export BLOCK_GAS_LIMIT=${BLOCK_GAS_LIMIT:-200000000}

forge script ./script/layer1/surge/DeploySurgeL1.s.sol:DeploySurgeL1 \
    --fork-url $FORK_URL \
    $BROADCAST_ARG \
    --ffi \
    $LOG_LEVEL \
    --private-key $PRIVATE_KEY \
    --block-gas-limit $BLOCK_GAS_LIMIT 