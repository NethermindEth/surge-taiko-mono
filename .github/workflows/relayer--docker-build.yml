name: "[Nethermind] Relayer and Migrations - Docker build and push"

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - "packages/relayer/**"
      - ".github/workflows/relayer--docker-build.yml"
  push:
    branches: [main]
    tags:
      - "relayer-v*"
    paths:
      - "packages/relayer/**"
      - ".github/workflows/relayer--docker-build.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  attestations: write
  contents: read

jobs:
  build-migrations:
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
    uses: NethermindEth/github-workflows/.github/workflows/docker-build-push-dockerhub.yaml@v1.5.1
    with:
      image_name: relayer-migrations
      runner: ${{ matrix.runner }}
      platforms: ${{ matrix.platform }}
      push: ${{ github.event_name != 'pull_request' }}
      context: packages/relayer
      dockerfile_path: packages/relayer/Dockerfile.migrations
      ignore_trivy: true # TODO: remove this once security issues are fixed
    secrets:
      dockerhub_username: ${{ secrets.DOCKER_USERNAME }}
      dockerhub_password: ${{ secrets.DOCKER_PASSWORD }}

  build-relayer:
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
    uses: NethermindEth/github-workflows/.github/workflows/docker-build-push-dockerhub.yaml@v1.5.1
    with:
      image_name: relayer
      runner: ${{ matrix.runner }}
      platforms: ${{ matrix.platform }}
      context: "."
      dockerfile_path: "packages/relayer/Dockerfile"
      push: ${{ github.event_name != 'pull_request' }}
      ignore_trivy: true # TODO: remove this once security issues are fixed
    secrets:
      dockerhub_username: ${{ secrets.DOCKER_USERNAME }}
      dockerhub_password: ${{ secrets.DOCKER_PASSWORD }}
